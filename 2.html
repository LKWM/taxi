<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cours de CorÃ©en - LeÃ§on 2</title> <!-- [ìˆ˜ì •] LeÃ§on 2 -->
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for audio synthesis -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', 'Nanum Gothic', sans-serif;
             overflow: hidden; /* [ìˆ˜ì •] */
        }
        /* Custom highlight class */
        .highlight {
            color: #16a34a; /* text-green-600 */
            font-weight: 600;
        }
        /* [ìˆ˜ì •] ëª¨ë°”ì¼/PC ê½‰ ì°¨ëŠ” ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³€ê²½ */
        #app-container {
            width: 100%;
            max-width: 1000px; /* ë°ìŠ¤í¬íƒ‘ ìµœëŒ€ ë„ˆë¹„ (Pratique íŒŒì¼ê³¼ ë™ì¼) */
            background-color: #facc15; /* bg-yellow-400 */
            border-radius: 1rem; /* rounded-2xl (Pratique íŒŒì¼ê³¼ ë™ì¼) */
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%; /* h-full */
        }
        /* [ìˆ˜ì •] Pratique íŒŒì¼ê³¼ ë™ì¼í•œ ì½˜í…ì¸  ì˜ì—­ */
        #page-content {
            flex-grow: 1;
            padding: 1.5rem; /* p-6 */
            overflow-y: auto; /* ë‚´ìš© ê¸¸ì–´ì§€ë©´ ìŠ¤í¬ë¡¤ */
            padding-bottom: 8rem; /* í•˜ë‹¨ ë°” ë†’ì´ë§Œí¼ ì—¬ë°± (ë„‰ë„‰í•˜ê²Œ) */
        }
        /* [ì¶”ê°€] Pratique íŒŒì¼ê³¼ ë™ì¼í•œ ë§ˆì´í¬/ë„¤ë¹„ê²Œì´ì…˜ ìŠ¤íƒ€ì¼ */
        .mic-btn {
            transition: all 0.2s ease-in-out;
        }
        .mic-btn.recording {
            transform: scale(1.1);
            background-color: #ef4444;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.4);
        }
        .mic-btn.loading {
            background-color: #6b7280;
            cursor: not-allowed;
            animation: pulse 1.5s infinite ease-in-out;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .nav-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            background-color: #facc15; /* bg-yellow-400 */
            border-top: 1px solid #eab308; /* yellow-500 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        @media (min-width: 640px) {
            .nav-container { padding: 1.5rem; }
            #page-content { padding-bottom: 6rem; }
        }
        #next-btn:disabled {
            background-color: #9ca3af; /* gray-400 */
            color: #e5e7eb; /* gray-200 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        #prev-btn:disabled {
             opacity: 0.5;
             cursor: not-allowed;
        }
        /* [ì¶”ê°€] í€´ì¦ˆ í”¼ë“œë°± ì˜ì—­ */
        .feedback-message {
            min-height: 2rem;
            font-weight: 600;
            margin-top: 1rem;
            font-size: 0.875rem; /* text-sm */
        }
        @media (min-width: 640px) { /* sm: */
             .feedback-message {
                 font-size: 1rem; /* text-base */
             }
        }
    </style>
</head>
<!-- [ìˆ˜ì •] ëª¨ë°”ì¼/PC ê½‰ ì°¨ëŠ” ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³€ê²½ -->
<body class="bg-gray-100 flex items-center justify-center min-h-screen h-screen p-2 sm:p-4">

    <!-- App Container -->
    <div id="app-container">
        <!-- Page Content: This will be dynamically rendered -->
        <div id="page-content" class="flex flex-col justify-center">
            <!-- Content appears here -->
        </div>

        <!-- [ìˆ˜ì •] Pratique íŒŒì¼ê³¼ ë™ì¼í•œ í•˜ë‹¨ ë°”ë¡œ êµì²´ -->
        <div id="navigation" class="nav-container">
             <div class="justify-self-start">
                 <button id="prev-btn" class="bg-white text-gray-800 font-bold py-1.5 px-3 text-sm sm:py-2 sm:px-5 sm:text-base rounded-full shadow-lg transition duration-300 hover:bg-gray-200">PrÃ©cÃ©dent</button>
             </div>
            
             <div class="flex-grow sm:flex-grow-0 sm:w-1/2 h-2 bg-yellow-600 rounded-full overflow-hidden mx-2">
                 <div id="progress-indicator" class="h-full bg-white transition-all duration-300"></div>
             </div>
            
             <div class="justify-self-end flex gap-2">
                 <!-- [ì¶”ê°€] ì¬ì‹œë„/ë„˜ì–´ê°€ê¸° ë²„íŠ¼ -->
                 <button id="retry-btn" class="hidden bg-amber-500 text-white font-bold py-1.5 px-3 text-sm sm:py-2 sm:px-5 sm:text-base rounded-full shadow-lg transition duration-300 hover:bg-amber-600">RÃ©essayer</button>
                 <button id="passer-btn" class="hidden bg-amber-500 text-white font-bold py-1.5 px-3 text-sm sm:py-2 sm:px-5 sm:text-base rounded-full shadow-lg transition duration-300 hover:bg-amber-600">Passer</button>
                 <button id="next-btn" class="bg-white text-gray-800 font-bold py-1.5 px-3 text-sm sm:py-2 sm:px-5 sm:text-base rounded-full shadow-lg transition duration-300 hover:bg-gray-200">
                     Suivant
                 </button>
             </div>
        </div>
    </div>

    <script>
        // [!!!] ìˆ˜ì •: 'playAudio' í•¨ìˆ˜ê°€ ëˆ„ë½ë˜ì–´ ì „ì—­ ìŠ¤ì½”í”„ì— ì¶”ê°€í•©ë‹ˆë‹¤.
        function playAudio(url) {
            // [ìˆ˜ì •] URL ìœ íš¨ì„± ê²€ì‚¬ ë° Promise .catch() ì¶”ê°€
            if (!url || url.startsWith('URL_PLACEHOLDER_')) {
                console.warn('Audio URL is a placeholder or invalid:', url);
                return;
            }
            try {
                const audio = new Audio(url);
                audio.play().catch(e => { // [ìˆ˜ì •] Promise rejection í•¸ë“¤ë§
                    console.error("Error playing audio:", e.name, e.message);
                    const statusEl = document.querySelector('.speech-status-indicator:not(.hidden)');
                    if (statusEl) {
                        statusEl.innerText = "DÃ©solÃ©, l'audio n'a pas pu Ãªtre chargÃ©.";
                        statusEl.className = 'speech-status-indicator text-center text-red-500 mt-4';
                    }
                });
            } catch (e) { // [ìˆ˜ì •] ë™ê¸°ì  ì—ëŸ¬ (e.g. new Audio() ì‹¤íŒ¨)
                console.error("Error creating audio element:", e);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. STATE AND DATA ---
            let currentPage = 0;
            let scores = [];
            let attempts = {};
            let soundsReady = false;
            let audioPlayTimeout = null; // [ì¶”ê°€] ì˜¤ë””ì˜¤ ì¬ìƒ ì§€ì—°ì„ ìœ„í•œ íƒ€ì„ì•„ì›ƒ ID

            // [ì¶”ê°€] Naver API ì„¤ì •
            const BASE_44_ORIGIN = "https://coreeno.base44.app"; 
            const CLOVA_API_FUNCTION_URL = BASE_44_ORIGIN + '/api/functions/naverClovaSpeech';
            
            // [ì‚­ì œ] ê¸°ì¡´ SpeechRecognition API ì„¤ì •
            
            // Audio synth
            let pageTurnSynth, correctSound, wrongSound, completionSynth;
            if (typeof Tone !== 'undefined') {
                pageTurnSynth = new Tone.Synth().toDestination();
                completionSynth = new Tone.PolySynth(Tone.Synth).toDestination();
                correctSound = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 } }).toDestination();
                wrongSound = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.4, sustain: 0.1, release: 0.2 } }).toDestination();
            }

            const initAudioSynth = async () => {
                if (soundsReady) return;
                try {
                    await Tone.start();
                    soundsReady = true;
                    console.log('Audio context started.');
                } catch (e) {
                    console.error("Audio context could not be started: ", e);
                }
            };
            document.body.addEventListener('click', initAudioSynth, { once: true });
            document.body.addEventListener('touchstart', initAudioSynth, { once: true });
            
            // [*** ìˆ˜ì • ***] LeÃ§on 2 í˜ì´ì§€ ë°ì´í„° (í•´ì„¤ í˜ì´ì§€ ì‚­ì œ)
            const pages = [
                // [ìˆ˜ì •] Page 1: í‘œì§€
                { type: 'text', title: 'LeÃ§on 2 : Dire la destination', content: 'Appuyez sur "Suivant" pour commencer !' },
                // [ì¶”ê°€] Page 2: ê¸°ì¡´ Page 1ì˜ ë‚´ìš©
                { type: 'text', title: 'LeÃ§on 2', content: 'Bonjour ! Dans cette leÃ§on, on va apprendre comment dire la destination quand vous prenez un taxi. Dâ€™abord, comment se saluer avec le chauffeur en corÃ©en ?', audioFr: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763185992/lec%CC%A7on2-clip1_jttdar.mp3' },
                // Page 3 (old 2)
                { type: 'vocab', ko: 'ì•ˆë…•í•˜ì„¸ìš”', fr: 'Bonjour', audio: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763185783/%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%82%E1%85%A7%E1%86%BC%E1%84%92%E1%85%A1%E1%84%89%E1%85%A6%E1%84%8B%E1%85%AD_lgkx2j.mp3' },
                // Page 4 (old 3)
                { type: 'text', content: 'Oui ! On peut simplement dire <ì•ˆë…•í•˜ì„¸ìš”> peu importe le moment de la journÃ©e.', audioFr: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763186567/lec%CC%A7on2-clip2_lgxhmw.mp3' },
                // Page 5 (old 4)
                { type: 'vocab', ko: 'ì•ˆë…•í•˜ì„¸ìš”', fr: 'Bonjour', audio: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763185783/%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%82%E1%85%A7%E1%86%BC%E1%84%92%E1%85%A1%E1%84%89%E1%85%A6%E1%84%8B%E1%85%AD_lgkx2j.mp3', subtitle: 'RÃ©pÃ©tez encore une fois' },
                // [ìˆ˜ì •] Page 6 (old 5 + 6 í•©ì¹¨)
                { 
                    type: 'text_then_vocab', 
                    content: 'TrÃ¨s bien ! Maintenant, votre chauffeur vous demande oÃ¹ vous allez.', 
                    audioFr: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763191204/lec%CC%A7on2-clip3_sw8f2e.mp3', 
                    ko: 'ì–´ë””ë¡œ ê°ˆê¹Œìš”?', 
                    fr: 'OÃ¹ va-t-on ?', 
                    audio: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763184271/%E1%84%8B%E1%85%A5%E1%84%83%E1%85%B5%E1%84%85%E1%85%A9_%E1%84%80%E1%85%A1%E1%86%AF%E1%84%81%E1%85%A1%E1%84%8B%E1%85%AD_bthodd.mp3' 
                },
                // Page 7 (old 7)
                { type: 'text_with_vocab', ko: 'ì–´ë””ë¡œ ê°ˆê¹Œìš”?', 
                fr: 'OÃ¹ va-t-on ?', audio: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763184271/%E1%84%8B%E1%85%A5%E1%84%83%E1%85%B5%E1%84%85%E1%85%A9_%E1%84%80%E1%85%A1%E1%86%AF%E1%84%81%E1%85%A1%E1%84%8B%E1%85%AD_bthodd.mp3', 
                content: 'On utilise <-ê¹Œìš”?>, qui est une forme interrogative suggÃ©rant une action ou demandant lâ€™intention de lâ€™interlocuteur.', 
                audioFr: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763211149/lec%CC%A7on2-clip4_otqwfk.mp3' 
                },
                // Page 8 (old 8)
                { type: 'vocab', ko: 'ì–´ë””ë¡œ ê°ˆê¹Œìš”?', fr: 'OÃ¹ va-t-on ?', audio: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763184271/%E1%84%8B%E1%85%A5%E1%84%83%E1%85%B5%E1%84%85%E1%85%A9_%E1%84%80%E1%85%A1%E1%86%AF%E1%84%81%E1%85%A1%E1%84%8B%E1%85%AD_bthodd.mp3', subtitle: 'RÃ©pÃ©tez encore une fois' },
                // [ìˆ˜ì •] Page 9 (old 9 + 10 í•©ì¹¨)
                { 
                    type: 'text_then_vocab', 
                    content: 'Maintenant, rÃ©pondons Ã  la question du chauffeur, en disant â€œJe vais Ã  la gare de SÃ©oul.â€', 
                    audioFr: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763192983/lecon2-clip5_jpy29l.mp3',
                    ko: 'ì„œìš¸ì—­ìœ¼ë¡œ ê°€ ì£¼ì„¸ìš”', 
                    fr: 'Allez Ã  la gare de SÃ©oul, SVP', 
                    audio: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763184273/%E1%84%89%E1%85%A5%E1%84%8B%E1%85%AE%E1%86%AF%E1%84%8B%E1%85%A7%E1%86%A8%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9_%E1%84%80%E1%85%A1_%E1%84%8C%E1%85%AE%E1%84%89%E1%85%A6%E1%84%8B%E1%85%AD_uv4ay5.mp3' 
                },
                // Page 10 (old 11)
                { type: 'vocab', ko: 'ì„œìš¸ì—­ìœ¼ë¡œ ê°€ ì£¼ì„¸ìš”', fr: 'Allez Ã  la gare de SÃ©oul, SVP', 
                audio: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763184273/%E1%84%89%E1%85%A5%E1%84%8B%E1%85%AE%E1%86%AF%E1%84%8B%E1%85%A7%E1%86%A8%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9_%E1%84%80%E1%85%A1_%E1%84%8C%E1%85%AE%E1%84%89%E1%85%A6%E1%84%8B%E1%85%AD_uv4ay5.mp3', 
                subtitle: 'RÃ©pÃ©tez encore une fois' },
                // Page 11 (old 12)
                { type: 'text_with_vocab', ko: 'ì„œìš¸ì—­ìœ¼ë¡œ ê°€ ì£¼ì„¸ìš”', fr: 'Allez Ã  la gare de SÃ©oul, SVP', 
                audio: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763184273/%E1%84%89%E1%85%A5%E1%84%8B%E1%85%AE%E1%86%AF%E1%84%8B%E1%85%A7%E1%86%A8%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9_%E1%84%80%E1%85%A1_%E1%84%8C%E1%85%AE%E1%84%89%E1%85%A6%E1%84%8B%E1%85%AD_uv4ay5.mp3', 
                content: 'On utilise <(ìœ¼)ë¡œ> pour spÃ©cifier la direction ou la destination. Si le nom se termine par une consonne, on rajoute <ìœ¼ë¡œ>, si par une voyelle, <ë¡œ>.',
                audioFr: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763213381/lec%CC%A7on2-clip6_ibwgyg.mp3'
                },
                
                // Page 12 (old 13) - Quiz 1 (Review)
                { 
                    type: 'quiz', 
                    question: 'OÃ¹ devez-vous aller pour prendre un taxi ?', 
                    options: [
                        { ko: 'ë²„ìŠ¤ ì •ë¥˜ì¥', fr: 'ArrÃªt de bus', audio: 'URL_PLACEHOLDER_KO_BUS_STOP' }, 
                        { ko: 'íƒì‹œ ìŠ¹ê°•ì¥', fr: 'ArrÃªt de taxi', audio: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763193945/%E1%84%90%E1%85%A2%E1%86%A8%E1%84%89%E1%85%B5_%E1%84%89%E1%85%B3%E1%86%BC%E1%84%80%E1%85%A1%E1%86%BC%E1%84%8C%E1%85%A1%E1%86%BC_a0zltp.mp3' }, 
                        { ko: 'ê¸°ì°¨ì—­', fr: 'Gare', audio: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763211466/%E1%84%80%E1%85%B5%E1%84%8E%E1%85%A1%E1%84%8B%E1%85%A7%E1%86%A8_zbimey.mp3' }
                    ], 
                    correct: 1 
                },
                // Page 13 (old 14) - [ì‚­ì œ] í•´ì„¤ 1
                
                // Page 13 (old 15) - Quiz 2 (Review)
                { 
                    type: 'quiz', 
                    question: 'Quelle marque de taxi pouvez-vous prendre sans rÃ©servation ?', 
                    options: [
                        { ko: 'íœ´ë¬´', fr: 'CongÃ©', audio: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763211518/%E1%84%92%E1%85%B2%E1%84%86%E1%85%AE_zdglbm.mp3' }, 
                        { ko: 'ì˜ˆì•½', fr: 'RÃ©servÃ©', audio: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763211522/%E1%84%8B%E1%85%A8%E1%84%8B%E1%85%A3%E1%86%A8_sfmv5f.mp3' }, 
                        { ko: 'ë¹ˆì°¨', fr: 'Voiture vide', audio: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763211515/%E1%84%87%E1%85%B5%E1%86%AB%E1%84%8E%E1%85%A1_wqkr6u.mp3' }
                    ], 
                    correct: 2 
                },
                // Page 14 (old 16) - [ì‚­ì œ] í•´ì„¤ 2
                
                // Page 14 (old 17) - Quiz 3 (New)
                { 
                    type: 'quiz', 
                    question: 'Que va vous dire le chauffeur quand vous prendrez son taxi ?', 
                    options: [
                        { ko: 'ì–´ë””ì„¸ìš”?', fr: 'OÃ¹ Ãªtes-vous ?', audio: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763184283/%E1%84%8B%E1%85%A5%E1%84%83%E1%85%B5%E1%84%89%E1%85%A6%E1%84%8B%E1%85%AD_f39ww2.mp3' }, 
                        { ko: 'ì–´ë””ë¡œ ê°ˆê¹Œìš”?', fr: 'OÃ¹ va-t-on ?', audio: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763184271/%E1%84%8B%E1%85%A5%E1%84%83%E1%85%B5%E1%84%85%E1%85%A9_%E1%84%80%E1%85%A1%E1%86%AF%E1%84%81%E1%85%A1%E1%84%8B%E1%85%AD_bthodd.mp3' }, 
                        { ko: 'ì–´ë””ì— ìˆì–´ìš”?', fr: 'OÃ¹ se trouve-t-il ?', audio: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763184286/%E1%84%8B%E1%85%A5%E1%84%83%E1%85%B5%E1%84%8B%E1%85_A6_%E1%84%8B%E1%85%B5%E1%86%BB%E1%84%8B%E1%85_A5%E1%84%8B%E1%85_AD_avrsnj.mp3' }
                    ], 
                    correct: 1 
                },
                // Page 15 (old 18) - [ì‚­ì œ] í•´ì„¤ 3
                
                // Page 15 (old 19) - Quiz 4 (New)
                { 
                    type: 'quiz', 
                    question: 'Comment dites-vous â€œAllez Ã  la gare de SÃ©oul, SVPâ€ ?', 
                    options: [
                        { ko: 'ì„œìš¸ì—­ìœ¼ë¡œ ê°€ ì£¼ì„¸ìš”', fr: 'Allez Ã  la gare de SÃ©oul, SVP', audio: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763184273/%E1%84%89%E1%85%A5%E1%84%8B%E1%85%AE%E1%86%AF%E1%84%8B%E1%85%A7%E1%86%A8%E1%84%8B%E1%85%B3%E1%84%85%E1%85%A9_%E1%84%80%E1%85%A1_%E1%84%8C%E1%85%AE%E1%84%89%E1%85%A6%E1%84%8B%E1%85%AD_uv4ay5.mp3' }, 
                        { ko: 'ì„œìš¸ì—­ì— ìˆì–´ìš”', fr: 'Je suis Ã  la gare de SÃ©oul', audio: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763194511/%E1%84%89%E1%85%A5%E1%84%8B%E1%85%AE%E1%86%AF%E1%84%8B%E1%85%A7%E1%86%A8%E1%84%8B%E1%85%A6_%E1%84%8B%E1%85%B5%E1%86%BB%E1%84%8B%E1%85_A5%E1%84%8B%E1%85_AD_otlbdq.mp3' }, 
                        { ko: 'ì„œìš¸ì—­ì´ì—ìš”', fr: 'C\'est la gare de SÃ©oul', audio: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763184280/%E1%84%89%E1%85%A5%E1%84%8B%E1%85%AE%E1%86%AF%E1%84%8B%E1%85%A7%E1%86%A8%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%A6%E1%84%8B%E1%85_AD_zyt3cd.mp3' }
                    ], 
                    correct: 0 
                },
                // Page 16 (old 20) - [ì‚­ì œ] í•´ì„¤ 4
                
                // Page 16 (old 21) - Speech Quiz 1
                { 
                    type: 'speech_quiz', 
                    ko: 'ì–´ë””ë¡œ ê°ˆê¹Œìš”?', 
                    fr: 'Dire : â€œOÃ¹ va-t-on?â€', 
                    audio: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763184271/%E1%84%8B%E1%85%A5%E1%84%83%E1%85%B5%E1%84%85%E1%85%A9_%E1%84%80%E1%85%A1%E1%86%AF%E1%84%81%E1%85%A1%E1%84%8B%E1%85%AD_bthodd.mp3' 
                },
                // Page 17 (old 22) - [ì‚­ì œ] í•´ì„¤ 5
                
                // Page 17 (old 23) - Speech Quiz 2
                { 
                    type: 'speech_quiz', 
                    ko: 'ì„œìš¸ì—­ìœ¼ë¡œ ê°€ ì£¼ì„¸ìš”', 
                    fr: 'Dire : â€œAllez Ã  la gare de SÃ©oul, SVPâ€', 
                    audio: 'https://res.cloudinary.com/de76i94ia/video/upload/v1763184273/%E1%84%89%E1%85%A5%E1%84%8B%E1%85%AE%E1%86%AF%E1%84%8B%E1%85_A7%E1%86%A8%E1%84%8B%E1%85%B3%E1%84%85%E1%85_A9_%E1%84%80%E1%85_A1_%E1%84%8C%E1%85%AE%E1%84%89%E1%85_A6%E1%84%8B%E1%85%AD_uv4ay5.mp3' 
                },
                // Page 18 (old 24) - [ì‚­ì œ] í•´ì„¤ 6

                // Page 18 (old 25) - Finish
                { type: 'text', title: 'FÃ©licitations !', content: 'TrÃ¨s bien ! Passez Ã  la leÃ§on 3 et pratiquez dâ€™autres mots pour dÃ©signer votre destination.' }
            ];
            // [*** ìˆ˜ì • ë ***]
            
            const totalPages = pages.length;
            scores = Array(totalPages).fill(null); 
            
            // [ì‚­ì œ] URL ìˆ˜ì • ë¡œì§ (ì´ë¯¸ ì›ë³¸ ë°ì´í„°ì— ìˆ˜ì •ë¨)

            // --- [ì¶”ê°€] Naver API ì—°ë™ì„ ìœ„í•œ í•¨ìˆ˜ë“¤ ---
            let mediaRecorder;
            let audioChunks = [];
            let isRecording = false;
            let recordingTimeout;

            async function startRecording(quizIndex) {
                if (isRecording) return;
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert("Votre navigateur ne supporte pas l'enregistrement audio.");
                    return;
                }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    isRecording = true;
                    audioChunks = [];
                    let mimeType = 'audio/webm;codecs=opus';
                    if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = 'audio/webm';
                    if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = '';
                    
                    mediaRecorder = new MediaRecorder(stream, { mimeType: mimeType }); 
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                    mediaRecorder.onstart = () => {
                        document.querySelector(`#mic-btn-${quizIndex}`)?.classList.add('recording');
                        document.querySelector(`#speech-status-${quizIndex}`).textContent = "J'Ã©coute...";
                        document.querySelector(`#speech-status-${quizIndex}`).className = 'speech-status-indicator feedback-message text-center text-gray-700';
                        
                        clearTimeout(recordingTimeout);
                        recordingTimeout = setTimeout(() => { if (isRecording) stopRecording(quizIndex); }, 10000); // 10ì´ˆ
                    };
                    mediaRecorder.onstop = () => {
                        isRecording = false;
                        clearTimeout(recordingTimeout);
                        document.querySelector(`#mic-btn-${quizIndex}`)?.classList.remove('recording');
                        document.querySelector(`#mic-btn-${quizIndex}`)?.classList.add('loading');
                        document.querySelector(`#speech-status-${quizIndex}`).textContent = "Ã‰valuation en cours...";

                        const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = () => {
                            handlePronunciationEvaluation(quizIndex, reader.result);
                        };
                        stream.getTracks().forEach(track => track.stop());
                    };
                    mediaRecorder.start();
                } catch (err) {
                    console.error("Error starting recording:", err);
                    if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
                        alert("Impossible d'accÃ©der au microphone. Veuillez autoriser l'accÃ¨s.");
                    } else {
                        alert(`Erreur microphone: ${err.name}. Veuillez rÃ©essayer.`);
                    }
                }
            }

            function stopRecording(quizIndex) {
                clearTimeout(recordingTimeout);
                if (mediaRecorder && isRecording) mediaRecorder.stop();
            }

            function normalizeText(text) {
                if (typeof text !== 'string') return '';
                return text.trim().replace(/[.,!?'\s]/g, '');
            }

            async function handlePronunciationEvaluation(quizIndex, audioBase64) {
                const quiz = pages[quizIndex];
                const feedbackEl = document.querySelector(`#speech-status-${quizIndex}`);
                const micBtn = document.querySelector(`#mic-btn-${quizIndex}`);
                const attemptsEl = document.querySelector(`#attempts-${quizIndex}`); // [ì¶”ê°€]
                
                if (attempts[quizIndex] === undefined) attempts[quizIndex] = 0;
                attempts[quizIndex]++;
                const isFirstAttempt = attempts[quizIndex] === 1;
                
                try {
                    const response = await fetch(CLOVA_API_FUNCTION_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            audioBase64: audioBase64,
                            languageCode: "Kor", 
                            referenceText: quiz.ko
                        })
                    });
        
                    if (!response.ok) {
                        let errorDetails = "Erreur inconnue";
                        const errorText = await response.text(); 
                        try { const errorResult = JSON.parse(errorText); errorDetails = errorResult.error || JSON.stringify(errorResult); }
                        catch (e) { errorDetails = errorText; }
                        throw new Error(`Erreur du backend (${response.status}): ${errorDetails}`);
                    }
                    
                    const result = await response.json(); 
                    const transcribedText = result.text || '';
                    const score = (result.assessment ? result.assessment.pronunciation_score : 0) || 0;

                    // [ìš”ì²­ ì‚¬í•­] ì¸ì‹ëœ í…ìŠ¤íŠ¸ë¥¼ í”¼ë“œë°±ê³¼ í•¨ê»˜ í‘œì‹œ
                    const normalizedTranscribed = normalizeText(transcribedText);
                    const normalizedReference = normalizeText(quiz.ko);
                    
                    const isTextMatch = (normalizedTranscribed === normalizedReference);
                    const isScorePass = score >= 80; // [ìš”ì²­ ì‚¬í•­] 80ì  ì»·
                    
                    const isCorrect = isTextMatch && isScorePass; 
    
                    if (isCorrect) {
                        scores[quizIndex] = 1; // 1 = í†µê³¼
                        correctSound?.triggerAttackRelease('C5', '0.2s');
                        if(micBtn) micBtn.disabled = true;
                        if(feedbackEl) {
                            // [ìˆ˜ì •] í…ìŠ¤íŠ¸ í•„ë“œ ì¶”ê°€ ëŒ€ì‹ , í”¼ë“œë°±ì— ì¸ì‹ëœ í…ìŠ¤íŠ¸ í¬í•¨ + ì •ë‹µ(ko)
                            feedbackEl.innerHTML = `TrÃ¨s bien ! "${transcribedText}"<br>(RÃ©ponse: <span class="font-bold">${quiz.ko}</span>)`; // [ìˆ˜ì •] innerHTML
                            feedbackEl.className = 'speech-status-indicator feedback-message text-center text-green-600';
                        }
                        if(attemptsEl) attemptsEl.textContent = 'TerminÃ© !'; // [ì¶”ê°€]

                        // [ì¶”ê°€] AIDE: 1íšŒ ì‹œë„ì— í†µê³¼í–ˆìœ¼ë¯€ë¡œ í˜¹ì‹œ ë²„íŠ¼ì´ ìˆì—ˆë‹¤ë©´ ìˆ¨ê¹€
                        const aideBtn = document.querySelector(`#aide-btn-${quizIndex}`);
                        if (aideBtn) aideBtn.style.display = 'none';

                    } else {
                        if (isFirstAttempt) {
                            scores[quizIndex] = null; // ì¬ì‹œë„ ê¸°íšŒ
                            wrongSound?.triggerAttackRelease('A#2', '0.2s');
                            if(feedbackEl) {
                                //[ìš”ì²­ ì‚¬í•­] í…ìŠ¤íŠ¸ í•„ë“œ ì¶”ê°€ ëŒ€ì‹ , í”¼ë“œë°±ì— ì¸ì‹ëœ í…ìŠ¤íŠ¸ í¬í•¨
                                feedbackEl.textContent = `J'ai entendu : "${transcribedText || '...'}" (Score: ${score}). Ã‰coutez et parlez Ã  nouveau.`; 
                                feedbackEl.className = 'speech-status-indicator feedback-message text-center text-red-500';
                            }
                            if(attemptsEl) attemptsEl.textContent = 'Tentatives restantes : 1'; // [ì¶”ê°€]

                            // [ì¶”ê°€] Aide ğŸ’¡ ë²„íŠ¼ í‘œì‹œ
                            const speechContainer = feedbackEl.parentElement;
                            if (speechContainer && !document.querySelector(`#aide-btn-${quizIndex}`)) {
                                const aideBtn = document.createElement('button');
                                aideBtn.id = `aide-btn-${quizIndex}`;
                                aideBtn.className = 'bg-amber-500 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-amber-600 transition duration-300 text-sm mt-3';
                                aideBtn.innerHTML = 'Aide ğŸ’¡ Ã‰couter';
                                aideBtn.onclick = () => playAudio(quiz.audio);
                                speechContainer.appendChild(aideBtn);
                            }

                        } else {
                            scores[quizIndex] = 0; // ìµœì¢… ì‹¤íŒ¨
                            wrongSound?.triggerAttackRelease('A#2', '0.2s');
                            if(feedbackEl) {
                                // [ìˆ˜ì •] ì •ë‹µ(ko)ì„ í”¼ë“œë°±ì— í¬í•¨
                                feedbackEl.innerHTML = `RÃ©ponse: <span class="font-bold">${quiz.ko}</span> (Votre score: ${score} / 100)`; // [ìˆ˜ì •] innerHTML
                                feedbackEl.className = 'speech-status-indicator feedback-message text-center text-red-500';
                            }
                            if(micBtn) micBtn.disabled = true;
                            if(attemptsEl) attemptsEl.textContent = 'Tentatives Ã©puisÃ©es.'; // [ì¶”ê°€]

                            // [ì¶”ê°€] AIDE: 2íšŒ ì‹œë„ í›„ ì‹¤íŒ¨ ì‹œ ë²„íŠ¼ ìˆ¨ê¹€
                            const aideBtn = document.querySelector(`#aide-btn-${quizIndex}`);
                            if (aideBtn) aideBtn.style.display = 'none';
                        }
                    }
                    
                    // [ìš”ì²­ ì‚¬í•­] PostMessage
                    window.parent.postMessage({
                        type: 'pronunciation_result',
                        quizId: quizIndex,
                        naverScore: score,
                        pointsAwarded: scores[quizIndex], // 1(í†µê³¼) ë˜ëŠ” 0(ì‹¤íŒ¨)
                        transcribedText: transcribedText,
                        referenceText: quiz.ko,
                        isCorrect: isCorrect,
                        attempt: attempts[quizIndex],
                        assessment: result.assessment || { pronunciation_score: score }
                    }, '*');

                } catch (error) {
                    console.error("Erreur lors de l'Ã©valuation:", error); 
                    if(feedbackEl) {
                        feedbackEl.textContent = `Erreur de connexion. Veuillez rÃ©essayer.`;
                        feedbackEl.className = 'speech-status-indicator feedback-message text-center text-red-500';
                    }
                    if (attempts[quizIndex] > 0) attempts[quizIndex]--; 
                } finally {
                    if(micBtn) micBtn.classList.remove('loading');
                    updateNavButtons(); 
                }
            }
            // --- [ë] Naver API ë¡œì§ ---

            /**
             * [ìˆ˜ì •] quizIndexë¥¼ ë°›ë„ë¡ ë³€ê²½
             */
            function createSimpleVocabCard(data, quizIndex) {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-2xl shadow-xl w-full p-4 sm:p-6 flex flex-col items-center mb-4 sm:mb-6';
                
                const audioArea = document.createElement('div');
                audioArea.className = 'cursor-pointer hover:bg-gray-100 transition duration-300 p-2 rounded-lg w-full';
                audioArea.onclick = () => playAudio(data.audio);

                const koText = document.createElement('h2');
                koText.className = 'text-2xl sm:text-3xl font-bold text-gray-900 mb-1 sm:mb-2 text-center';
                koText.innerText = data.ko;
                audioArea.appendChild(koText);

                const frText = document.createElement('p');
                frText.className = 'text-base sm:text-lg text-gray-600 text-center';
                frText.innerText = data.fr;
                audioArea.appendChild(frText);
                
                const icon = document.createElement('span');
                icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 mt-2 mx-auto"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>';
                audioArea.appendChild(icon);
                
                card.appendChild(audioArea);
                
                // [!!!] ìš”ì²­ ì‚¬í•­: 'text_with_vocab' ì—ì„œëŠ” ìŒì„± ì¸ì‹ ì„¹ì…˜(createSpeechSection)ì„ í˜¸ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                // card.appendChild(createSpeechSection(quizIndex, data.ko)); // <- [ì‚­ì œ]
                
                return card;
            }

            /**
             * [ìˆ˜ì •] quizIndexë¥¼ ë°›ë„ë¡ ë³€ê²½
             */
            function createVocabCard(data, quizIndex) {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-2xl shadow-xl w-full p-4 sm:p-6 flex flex-col items-center';

                if (data.subtitle) {
                    const subtitleEl = document.createElement('p');
                    subtitleEl.className = 'text-lg sm:text-xl font-semibold text-gray-700 mb-4 text-center';
                    subtitleEl.innerText = data.subtitle;
                    card.appendChild(subtitleEl);
                }

                if (data.image) {
                    const img = document.createElement('img');
                    img.src = data.image;
                    img.alt = data.ko;
                    img.className = 'w-full h-32 sm:h-40 object-contain rounded-lg mb-4';
                    img.onerror = () => img.src = `https://placehold.co/400x200/eee/ccc?text=Image+${data.ko}`;
                    card.appendChild(img);
                }

                const koText = document.createElement('h2');
                koText.className = 'text-3xl sm:text-4xl font-bold text-gray-900 mb-2 text-center';
                koText.innerText = data.ko;
                card.appendChild(koText);

                const frText = document.createElement('p');
                frText.className = 'text-lg sm:text-xl text-gray-600 mb-4 sm:mb-6 text-center';
                frText.innerText = data.fr;
                card.appendChild(frText);

                const audioBtn = document.createElement('button');
                audioBtn.className = 'w-full bg-green-600 text-white font-bold py-2 px-4 sm:py-3 sm:px-6 rounded-full shadow-md hover:bg-green-700 transition duration-300 flex items-center justify-center gap-2 text-sm sm:text-base';
                audioBtn.innerHTML = 'Ã‰coutez <span><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg></span>';
                audioBtn.onclick = () => playAudio(data.audio);
                card.appendChild(audioBtn);

                // [!!!] ìš”ì²­ ì‚¬í•­: 'vocab' íƒ€ì…ì€ ìŒì„± ì¸ì‹ì„ ìœ ì§€í•©ë‹ˆë‹¤.
                // [ìˆ˜ì •] ë²„íŠ¼ í…ìŠ¤íŠ¸ 'RÃ©pÃ©tez' ì „ë‹¬
                card.appendChild(createSpeechSection(quizIndex, data, 'RÃ©pÃ©tez'));

                return card;
            }

            // [ì¶”ê°€] 2ë²ˆ ìš”ì²­: ë§í•˜ê¸° í€´ì¦ˆ ì „ìš© ì¹´ë“œ (ko, audio ìˆ¨ê¹€)
            function createSpeechQuizCard(data, quizIndex) {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-2xl shadow-xl w-full p-4 sm:p-6 flex flex-col items-center';

                // í”„ë‘ìŠ¤ì–´ ì§ˆë¬¸ë§Œ í‘œì‹œ
                const frText = document.createElement('p');
                frText.className = 'text-2xl sm:text-3xl font-bold text-gray-900 mb-4 sm:mb-6 text-center';
                frText.innerText = data.fr;
                card.appendChild(frText);

                // [ìˆ˜ì •] ë²„íŠ¼ í…ìŠ¤íŠ¸ 'Parlez' ì „ë‹¬
                card.appendChild(createSpeechSection(quizIndex, data, 'Parlez')); 

                return card;
            }


            /**
             * [ì¶”ê°€] ìŒì„±ì¸ì‹ ë²„íŠ¼/í”¼ë“œë°± ì„¹ì…˜ì„ ìƒì„±í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
             * [ìˆ˜ì •] buttonText íŒŒë¼ë¯¸í„° ì¶”ê°€
             */
            function createSpeechSection(quizIndex, pageData, buttonText = 'RÃ©pÃ©tez') { // [ìˆ˜ì •]
                const correctKoreanText = pageData.ko;
                
                const speechContainer = document.createElement('div');
                speechContainer.className = 'w-full flex flex-col items-center mt-4';
                
                const repeatBtn = document.createElement('button');
                repeatBtn.id = `mic-btn-${quizIndex}`;
                // [ìˆ˜ì •] Pratique 1ê³¼ ë™ì¼í•˜ê²Œ íŒŒë€ìƒ‰ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
                repeatBtn.className = 'mic-btn bg-sky-500 text-white font-bold py-2 px-4 sm:py-3 sm:px-6 rounded-full shadow-md hover:bg-sky-600 transition duration-300 flex items-center justify-center gap-2 text-sm sm:text-base';
                
                // [ìˆ˜ì •] ë²„íŠ¼ í…ìŠ¤íŠ¸ ë™ì  ì„¤ì •
                repeatBtn.innerHTML = `${buttonText} <span><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg></span>`;
                
                speechContainer.appendChild(repeatBtn);

                const speechStatus = document.createElement('p');
                speechStatus.id = `speech-status-${quizIndex}`;
                // [ìˆ˜ì •] í…ìŠ¤íŠ¸ í•„ë“œ(transcript)ì™€ í”¼ë“œë°± ë©”ì‹œì§€(feedback)ë¥¼ ë¶„ë¦¬
                speechStatus.className = 'speech-status-indicator feedback-message text-center h-6 text-sm sm:text-base';
                speechContainer.appendChild(speechStatus);
                
                // [ìš”ì²­ ì‚¬í•­] ì¸ì‹ëœ í…ìŠ¤íŠ¸ í•„ë“œ ì¶”ê°€
                const transcriptEl = document.createElement('p');
                transcriptEl.id = `transcript-${quizIndex}`;
                transcriptEl.className = 'text-base sm:text-lg text-slate-500 h-6 mt-1';
                speechContainer.appendChild(transcriptEl);

                const attemptsEl = document.createElement('div');
                attemptsEl.id = `attempts-${quizIndex}`;
                attemptsEl.className = 'text-xs sm:text-sm text-slate-400 mt-1';
                attemptsEl.textContent = 'Tentatives restantes : 2';
                speechContainer.appendChild(attemptsEl);

                // [ì¶”ê°€] ë Œë”ë§ ì‹œ ê¸°ì¡´ ìƒíƒœ(ì‹œë„ íšŸìˆ˜, ì ìˆ˜) ë³µì›
                const currentAttempts = attempts[quizIndex] || 0;
                const currentScore = scores[quizIndex];
                
                attemptsEl.textContent = `Tentatives restantes : ${Math.max(0, 2 - currentAttempts)}`;

                if (currentScore === 1) { // 1 = í†µê³¼
                    repeatBtn.disabled = true;
                    // [ìˆ˜ì •] ì •ë‹µ(ko)ì„ í”¼ë“œë°±ì— í¬í•¨
                    speechStatus.innerHTML = `TrÃ¨s bien ! (RÃ©ponse: <span class="font-bold">${correctKoreanText}</span>)`; // [ìˆ˜ì •] innerHTML
                    speechStatus.className = 'speech-status-indicator feedback-message text-center text-green-600';
                    attemptsEl.textContent = 'TerminÃ© !';
                } else if (currentScore === 0) { // 0 = ìµœì¢… ì‹¤íŒ¨
                    repeatBtn.disabled = true;
                    // [ìˆ˜ì •] ì •ë‹µ(ko)ì„ í”¼ë“œë°±ì— í¬í•¨
                    speechStatus.innerHTML = `RÃ©ponse: <span class="font-bold">${correctKoreanText}</span>`; // [ìˆ˜ì •] innerHTML
                    speechStatus.className = 'speech-status-indicator feedback-message text-center text-red-500';
                    attemptsEl.textContent = 'Tentatives Ã©puisÃ©es.';
                } else if (currentAttempts >= 2) { // 2íšŒ ì‹œë„, ì•„ì§ ì ìˆ˜ ì—†ìŒ (ì´ ê²½ìš°ëŠ” 0ì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´ì•¼ í•¨)
                    repeatBtn.disabled = true;
                     // [ìˆ˜ì •] ì •ë‹µ(ko)ì„ í”¼ë“œë°±ì— í¬í•¨
                    speechStatus.innerHTML = `RÃ©ponse: <span class="font-bold">${correctKoreanText}</span>`; // [ìˆ˜ì •] innerHTML
                    speechStatus.className = 'speech-status-indicator feedback-message text-center text-red-500';
                    attemptsEl.textContent = 'Tentatives Ã©puisÃ©es.';
                    if(currentScore === null) scores[quizIndex] = 0; // ìƒíƒœ ë™ê¸°í™”
                } else if (currentAttempts === 1) { // 1íšŒ ì‹œë„, ì‹¤íŒ¨ (ì¬ì‹œë„ ê¸°íšŒ)
                    speechStatus.textContent = `Ã‰coutez et parlez Ã  nouveau.`;
                    speechStatus.className = 'speech-status-indicator feedback-message text-center text-red-500';

                    // [ì¶”ê°€] Aide ğŸ’¡ ë²„íŠ¼ (í˜ì´ì§€ ë‹¤ì‹œ ë¡œë“œ ì‹œ)
                    if (speechContainer && !document.querySelector(`#aide-btn-${quizIndex}`)) {
                        const aideBtn = document.createElement('button');
                        aideBtn.id = `aide-btn-${quizIndex}`;
                        aideBtn.className = 'bg-amber-500 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-amber-600 transition duration-300 text-sm mt-3';
                        aideBtn.innerHTML = 'Aide ğŸ’¡ Ã‰couter';
                        aideBtn.onclick = () => playAudio(pageData.audio);
                        speechContainer.appendChild(aideBtn);
                    }
                }
                // (currentAttempts === 0 and currentScore === null) -> ê¸°ë³¸ ìƒíƒœ (ì•„ë¬´ê²ƒë„ ì•ˆí•¨)


                repeatBtn.onclick = () => {
                    const currentAttemptsOnClick = attempts[quizIndex] || 0; // í´ë¦­ ì‹œì ì˜ ì‹œë„ íšŸìˆ˜ ì¬í™•ì¸
                    if (repeatBtn.disabled || repeatBtn.classList.contains('loading')) return;
                    
                    // [ìˆ˜ì •] 2íšŒ ì‹œë„ ì œí•œ (scores[quizIndex] === null ì¡°ê±´ ì œê±°)
                    if (currentAttemptsOnClick >= 2) {
                        return; 
                    }
                    
                    if (isRecording) stopRecording(quizIndex);
                    else {
                        initAudioSynth(); 
                        startRecording(quizIndex);
                    }
                };

                return speechContainer;
            }

            /**
             * [ìˆ˜ì •] quizIndexë¥¼ ë°›ë„ë¡ ë³€ê²½, ë°˜ì‘í˜• UI ì ìš©
             */
            function createQuizCard(data, quizIndex) {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-2xl shadow-xl w-full p-4 sm:p-6 flex flex-col items-center';

                const questionText = document.createElement('p');
                questionText.className = 'text-lg sm:text-xl font-semibold text-gray-900 mb-4 sm:mb-6 text-center';
                questionText.innerText = data.question;
                card.appendChild(questionText);

                const optionsContainer = document.createElement('form'); 
                optionsContainer.id = `quiz-form-${quizIndex}`;
                optionsContainer.className = 'w-full flex flex-col gap-3';
                
                data.options.forEach((option, index) => {
                    const optionBtn = document.createElement('button');
                    optionBtn.type = 'button'; 
                    // [ìˆ˜ì •] text-left -> text-center, í°íŠ¸ í¬ê¸° ì¡°ì •
                    optionBtn.className = 'quiz-option-btn w-full bg-gray-100 text-gray-800 font-medium p-3 sm:p-4 rounded-xl shadow-sm hover:bg-gray-200 transition duration-300 text-lg sm:text-xl text-center'; 
                    optionBtn.innerHTML = `<span class="font-bold">${option.ko}</span>`; // [ìˆ˜ì •] fr ì‚­ì œ
                    optionBtn.dataset.index = index;
                    
                    optionBtn.addEventListener('click', () => {
                        // [ìˆ˜ì •] ì˜¤ë””ì˜¤ ì¬ìƒ ë¡œì§ì„ checkAnswerë¡œ ì´ë™
                        // playAudio(option.audio); 
                        checkAnswer(optionBtn, index, data.correct);
                    });
                    
                    optionsContainer.appendChild(optionBtn);
                });

                card.appendChild(optionsContainer);
                
                const quizFeedback = document.createElement('p');
                quizFeedback.id = `quiz-feedback-${quizIndex}`;
                quizFeedback.className = 'quiz-feedback-indicator feedback-message text-center h-6 text-sm sm:text-base';
                card.appendChild(quizFeedback);

                return card;
            }

            // [ì‚­ì œ] 1ë²ˆ ìš”ì²­: í€´ì¦ˆ í•´ì„¤ ì¹´ë“œ (checkAnswerì— í†µí•©ë¨)
            // function createQuizExplanationCard(data) { ... }


            /**
             * Go to the next page.
             */
            window.nextPage = function() {
                if (document.getElementById('next-btn').disabled) return;
                if (currentPage < pages.length - 1) {
                    currentPage++;
                    renderPage();
                    playPageTurnSound();
                }
                
                // [ì¶”ê°€] ë§ˆì§€ë§‰ í˜ì´ì§€ PostMessage
                if (currentPage === pages.length - 1) {
                     window.parent.postMessage({ type: 'lesson_complete' }, '*');
                     console.log('Lesson complete message sent to parent.');
                }
            }

            /**
             * Go to the previous page.
             */
            window.prevPage = function() {
                if (document.getElementById('prev-btn').disabled) return;
                if (currentPage > 0) {
                    currentPage--;
                    renderPage();
                    playPageTurnSound();
                }
            }

            /**
             * [ìˆ˜ì •] Pratique 1ê³¼ ë™ì¼í•œ ë„¤ë¹„ê²Œì´ì…˜ ë¡œì§
             */
            function updateNavButtons() {
                const prevBtn = document.getElementById('prev-btn');
                const nextBtn = document.getElementById('next-btn');
                const retryBtn = document.getElementById('retry-btn');
                const passerBtn = document.getElementById('passer-btn');

                prevBtn.disabled = (currentPage === 0);
                
                const isLastPage = currentPage === pages.length - 1;
                nextBtn.style.visibility = isLastPage ? 'hidden' : 'visible';
                
                passerBtn.classList.add('hidden');
                retryBtn.classList.add('hidden');

                const pageData = pages[currentPage];
                const quizIndex = currentPage;
                
                // [ìˆ˜ì •] 'quiz' (MCQ) í˜ì´ì§€ë§Œ 'ë‹¤ìŒ' ë²„íŠ¼ ë¹„í™œì„±í™” ë¡œì§ì„ ì ìš©
                if (pageData.type === 'quiz') { 
                    const isAnswered = scores[quizIndex] !== null;
                    nextBtn.disabled = !isAnswered;
                    
                    // MCQ 1íšŒ ì‹¤íŒ¨ ì‹œ (0ì ) 'Retry' ë²„íŠ¼ í‘œì‹œ
                    if (scores[quizIndex] === 0) { // 1íšŒ ì‹œë„ 0ì 
                         retryBtn.classList.remove('hidden');
                         nextBtn.disabled = true;
                    }
                } 
                // [ìˆ˜ì •] 'vocab' (ë”°ë¼ë§í•˜ê¸°) í˜ì´ì§€ ë¡œì§
                else if (pageData.type === 'vocab' || pageData.type === 'speech_quiz') { // [ìˆ˜ì •] speech_quiz ì¶”ê°€
                    nextBtn.disabled = false; // [ìˆ˜ì •] ë”°ë¼ë§í•˜ê¸°ëŠ” 'ë‹¤ìŒ' ë²„íŠ¼ì„ ë§‰ì§€ ì•ŠìŒ

                    // 2íšŒ ì‹œë„ í›„ 0ì ì¼ ë•Œ (ì‹¤íŒ¨) 'Passer' ë²„íŠ¼ í‘œì‹œ
                    if ((attempts[quizIndex] || 0) >= 2 && scores[quizIndex] === 0) {
                        passerBtn.classList.remove('hidden');
                        // 'ë‹¤ìŒ' ë²„íŠ¼ì€ í™œì„± ìƒíƒœë¡œ ë‘ 
                    }
                }
                else {
                    // 'text', 'text_with_vocab' í˜ì´ì§€ëŠ” í•­ìƒ 'ë‹¤ìŒ' í™œì„±í™” (ë§ˆì§€ë§‰ í˜ì´ì§€ ì œì™¸)
                    nextBtn.disabled = isLastPage;
                }
            }

            // --- 3. HELPER FUNCTIONS ---

            function playPageTurnSound() {
                const isLastPage = currentPage === pages.length - 1;
                if (isLastPage && completionSynth) {
                    completionSynth.triggerAttackRelease(["C5", "E5", "G5"], "4n", Tone.now());
                } else if (pageTurnSynth) {
                    pageTurnSynth.triggerAttackRelease("C5", "8n", Tone.now());
                }
            }

            function highlightText(text) {
                return text.replace(/<([^>]+)>/g, '<span class="highlight">$1</span>');
            }

            /**
             * [ìˆ˜ì •] MCQ (í€´ì¦ˆ) ë‹µë³€ í™•ì¸ ë¡œì§
             */
            function checkAnswer(buttonElement, selectedIndex, correctIndex) {
                const quizIndex = currentPage;
                if (scores[quizIndex] !== null) return; 

                initAudioSynth(); 
                
                const allOptionButtons = buttonElement.parentElement.querySelectorAll('button');
                const feedbackEl = document.getElementById(`quiz-feedback-${quizIndex}`);
                const pageData = pages[quizIndex];
                
                attempts[quizIndex] = (attempts[quizIndex] || 0) + 1;

                if (selectedIndex === correctIndex) {
                    scores[quizIndex] = attempts[quizIndex] === 1 ? 2 : 1; // 1ì°¨ 2ì , 2ì°¨ 1ì 
                    
                    playAudio(pageData.options[selectedIndex].audio); // [ìˆ˜ì •] ì •ë‹µì¼ ë•Œë§Œ ì˜¤ë””ì˜¤ ì¬ìƒ
                    
                    buttonElement.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    buttonElement.classList.add('bg-green-500', 'text-white');
                    if (feedbackEl) {
                        feedbackEl.textContent = 'TrÃ¨s bien !';
                        feedbackEl.className = 'quiz-feedback-indicator text-center font-medium mt-4 h-6 text-green-600';
                    }
                    correctSound?.triggerAttackRelease('C5', '0.2s');
                    allOptionButtons.forEach(btn => { btn.disabled = true; });

                    allOptionButtons.forEach((btn, index) => {
                        // [ìˆ˜ì •] ì •ë‹µ í´ë¦­ ì‹œ, ëª¨ë“  ë²„íŠ¼ì— ë²ˆì—­ í‘œì‹œ
                        btn.innerHTML = `<span class="font-bold">${pageData.options[index].ko}</span><br><span class="text-base font-normal">${pageData.options[index].fr}</span>`;
                        btn.classList.add('text-center', 'p-3', 'sm:p-4'); 
                        if(index !== correctIndex) {
                            btn.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                            btn.classList.add('bg-gray-200', 'text-gray-700'); 
                        }
                    });
                } else {
                    // [ìˆ˜ì •] ì˜¤ë‹µì¼ ë• ì˜¤ë””ì˜¤ ì¬ìƒ ì•ˆ í•¨
                    if (attempts[quizIndex] >= 2) scores[quizIndex] = 0; // 2íšŒ ì‹¤íŒ¨
                    buttonElement.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    buttonElement.classList.add('bg-red-500', 'text-white');
                    if (feedbackEl) {
                        feedbackEl.textContent = 'Pas tout Ã  fait. RÃ©essayez !';
                        feedbackEl.className = 'quiz-feedback-indicator text-center font-medium mt-4 h-6 text-red-500';
                    }
                    wrongSound?.triggerAttackRelease('A#2', '0.2s');
                    
                    buttonElement.disabled = true; 
                    setTimeout(() => {
                        buttonElement.disabled = false;
                        buttonElement.classList.remove('bg-red-500', 'text-white');
                        buttonElement.classList.add('bg-gray-100', 'hover:bg-gray-200');
                        if (feedbackEl) feedbackEl.textContent = '';
                    }, 1500);
                }
                
                updateNavButtons();
            }

            // --- 4. INITIALIZATION ---
            
            // [ìˆ˜ì •] DOMContentLoaded ë°–ì˜ í•¨ìˆ˜ë“¤ì„ ë¦¬ìŠ¤ë„ˆë¡œ ì—°ê²°
            document.getElementById('prev-btn').addEventListener('click', prevPage);
            document.getElementById('next-btn').addEventListener('click', nextPage);

            // [ì¶”ê°€] Retry/Passer ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('retry-btn').addEventListener('click', () => {
                 const quizIndex = currentPage;
                 scores[quizIndex] = null;
                 attempts[quizIndex] = 0;
                 renderPage(); // í˜ì´ì§€ ë‹¤ì‹œ ê·¸ë¦¼
            });

            document.getElementById('passer-btn').addEventListener('click', () => {
                 const quizIndex = currentPage;
                 if (scores[quizIndex] === null) scores[quizIndex] = 0; 
                 if (currentPage < pages.length - 1) { // [ì˜¤ë¥˜ ìˆ˜ì •] currentPageIndex -> currentPage
                      currentPage++;
                      renderPage();
                 }
            });
            
            // [!!!] ìˆ˜ì •: í€´ì¦ˆ í˜ì´ì§€ë¥¼ ë™ì ìœ¼ë¡œ ìƒì„±/ë Œë”ë§í•˜ëŠ” ë¡œì§
            function renderPage() {
                // [ì˜¤ë¥˜ ìˆ˜ì •] scorePageì— ë„ë‹¬í•˜ë©´ ë Œë”ë§ì„ ì¤‘ë‹¨í•˜ëŠ” ë¬¸ì œ ìˆ˜ì •
                if (currentPage >= totalPages) return; 

                // [ì¶”ê°€] 1.5ì´ˆ ì§€ì—° ì˜¤ë””ì˜¤ íƒ€ì´ë¨¸ í´ë¦¬ì–´
                if (audioPlayTimeout) {
                    clearTimeout(audioPlayTimeout);
                    audioPlayTimeout = null;
                }

                const pageData = pages[currentPage];
                const contentEl = document.getElementById('page-content');
                contentEl.innerHTML = ''; // ì´ì „ ë‚´ìš© ì§€ìš°ê¸°
                contentEl.scrollTop = 0; // ìŠ¤í¬ë¡¤ ë§¨ ìœ„ë¡œ

                // [ìš”ì²­] í”„ë‘ìŠ¤ì–´ ì„¤ëª… í˜ì´ì§€ ìë™ì¬ìƒ ì˜¤ë””ì˜¤ ì¶”ê°€
                // [ìˆ˜ì •] URLì´ í”Œë ˆì´ìŠ¤í™€ë”ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì¬ìƒ
                if (pageData.audioFr && !pageData.audioFr.startsWith('URL_PLACEHOLDER_')) {
                    // ì´ì „ ì˜¤ë””ì˜¤ê°€ ìˆë‹¤ë©´ ì¦‰ì‹œ ì¤‘ì§€
                    const existingAudio = document.getElementById('french-guide-audio');
                    if (existingAudio) {
                        existingAudio.pause();
                        existingAudio.remove();
                    }
                    
                    // [ìˆ˜ì •] 1.5ì´ˆ ì§€ì—° í›„ ì˜¤ë””ì˜¤ ìƒì„± ë° ì¬ìƒ
                    audioPlayTimeout = setTimeout(() => {
                        const audioEl = document.createElement('audio');
                        audioEl.src = pageData.audioFr; // í”Œë ˆì´ìŠ¤í™€ë” URL
                        audioEl.style.display = 'none';
                        audioEl.id = 'french-guide-audio';
                        
                        // DOMì— ì¶”ê°€í•œ í›„ play
                        contentEl.appendChild(audioEl);

                        audioEl.play().catch(error => {
                            // [ìˆ˜ì •] ìë™ì¬ìƒ ì‹¤íŒ¨ëŠ” í”í•˜ë¯€ë¡œ, ì½˜ì†”ì— ê²½ê³ ë§Œ í‘œì‹œí•˜ê³  ë¬´ì‹œ
                             console.warn(`Autoplay for ${pageData.audioFr} failed:`, error.name);
                        });
                        
                    }, 1500); // 1.5ì´ˆ ì§€ì—°
                }
                // [ìš”ì²­ ë]

                // [ìˆ˜ì •] ëª¨ë°”ì¼ ë°˜ì‘í˜• í°íŠ¸ í¬ê¸° ì ìš©
                switch (pageData.type) {
                    case 'text': { // [ìˆ˜ì •]
                        if (pageData.title) {
                            const title = document.createElement('h1');
                            title.className = 'text-2xl sm:text-3xl font-bold text-gray-900 mb-4 sm:mb-6 text-center';
                            title.innerText = pageData.title;
                            contentEl.appendChild(title);
                        }
                        const text = document.createElement('p');
                        text.className = 'text-lg sm:text-xl text-gray-800 leading-relaxed text-center'; 
                        text.innerHTML = highlightText(pageData.content);
                        contentEl.appendChild(text);
                        break;
                    } // [ìˆ˜ì •]

                    case 'text_with_vocab': { // [ìˆ˜ì •]
                        contentEl.appendChild(createSimpleVocabCard(pageData, currentPage));
                        const explanationText = document.createElement('p');
                        explanationText.className = 'text-lg sm:text-xl text-gray-800 leading-relaxed text-center mt-4 sm:mt-6'; 
                        explanationText.innerHTML = highlightText(pageData.content);
                        contentEl.appendChild(explanationText);
                        break;
                    } // [ìˆ˜ì •]

                    // [ì¶”ê°€] 4ë²ˆ ìš”ì²­: ì„¤ëª…(text)ì´ ë¨¼ì € ë‚˜ì˜¤ê³  vocab cardê°€ ë‚˜ì˜¤ëŠ” íƒ€ì…
                    case 'text_then_vocab': { // [ìˆ˜ì •]
                        if (pageData.title) {
                             const title = document.createElement('h1');
                             title.className = 'text-2xl sm:text-3xl font-bold text-gray-900 mb-4 sm:mb-6 text-center';
                             title.innerText = pageData.title;
                             contentEl.appendChild(title);
                        }
                        const text = document.createElement('p');
                        text.className = 'text-lg sm:text-xl text-gray-800 leading-relaxed text-center mb-4 sm:mb-6'; // [ì¶”ê°€] margin-bottom
                        text.innerHTML = highlightText(pageData.content);
                        contentEl.appendChild(text);
                        
                        // 'vocab' card (ìŒì„±ì¸ì‹ í¬í•¨)
                        contentEl.appendChild(createVocabCard(pageData, currentPage));
                        break;
                    } // [ìˆ˜ì •]

                    case 'vocab': { // [ìˆ˜ì •]
                        contentEl.appendChild(createVocabCard(pageData, currentPage));
                        break;
                    } // [ìˆ˜ì •]

                    case 'quiz': { // [ìˆ˜ì •]
                        contentEl.appendChild(createQuizCard(pageData, currentPage));
                        break;
                    } // [ìˆ˜ì •]
                    
                    // [ìˆ˜ì •] í•´ì„¤ í˜ì´ì§€ ì¼€ì´ìŠ¤ ì‚­ì œ
                    case 'speech_quiz': {
                        contentEl.appendChild(createSpeechQuizCard(pageData, currentPage));
                        break;
                    }
                    // [ì‚­ì œ]
                    // case 'quiz_explanation': {
                    //     contentEl.appendChild(createQuizExplanationCard(pageData));
                    //     break;
                    // }
                    // case 'quiz_explanation_speech': {
                    //     contentEl.appendChild(createSimpleVocabCard(pageData, currentPage));
                    //     break;
                    // }
                }
                updateNavButtons();
                updateProgressBar();
            }
            
            function updateProgressBar() {
                const progress = (currentPage / (totalPages - 1)) * 100;
                document.getElementById('progress-indicator').style.width = `${progress}%`;
            }
            
            // Initial render on page load
            renderPage();
        });
    </script>

</body>
</html>
